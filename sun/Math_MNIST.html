<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MNIST</title>
</head>

<body>
	<div id="container">
	</div>
	<!-- <input type="range" min="0" max="10" step="0.1" oninput="changeValue1(this.value)">
	<input type="range" min="0" max="10" step="0.1" oninput="changeValue2(this.value)">
	<input type="range" min="0" max="10" step="0.1" oninput="changeValue3(this.value)"> -->
</body>

<style>
	body {
		margin: 0px;
		height: 100%;
		width: 100%;
		background-color: rgb(255, 255, 255);
	}

	#container {
		width: 100%;
		height: 100%;
		padding: auto;
		background-color: rgb(255, 255, 255);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}

	#container>canvas {
		/* width: 500px; */
		height: 100%;
		/* width: 100%; */
		/* height: 500px; */
	}
</style>

<script type="module">
	import * as SUN from './GBsun.js'
	import * as NN from './SUN_NN.js'

	let gameconsole = new SUN.sunConsole(500, 500, true)

	document.getElementById('container').appendChild(gameconsole.get_ConsoleDOM())

	const Font = SUN.Font.DEFAULT()

	const Color = {
		0: SUN.Color.PICO(0),
		1: SUN.Color.PICO(1),
		2: SUN.Color.PICO(2),
		3: SUN.Color.PICO(3),
		4: SUN.Color.PICO(4),
		5: SUN.Color.PICO(5),
		6: SUN.Color.PICO(6),
		7: SUN.Color.PICO(7),
		8: SUN.Color.PICO(8),
		9: SUN.Color.PICO(9),
		10: SUN.Color.PICO(10),
		11: SUN.Color.PICO(11),
		12: SUN.Color.PICO(12),
		13: SUN.Color.PICO(13),
		14: SUN.Color.PICO(14),
		15: SUN.Color.PICO(15)
	}

	const WHITE = SUN.Color.COLOR('white')
	const HIGHLIGHT = SUN.Color.PICO(10)
	const FUNCTION = SUN.Color.PICO(14)
	const TESTCOLOR = SUN.Color.RGB8(255, 255, 0, 20)

	// out
	let o1 = new NN.Neuron('Out1', 2);
	// let o2 = new Neuron('Out2', 3);
	let nodes = [o1];
	let outs = [o1];
	let h2s = [];

	for (let i = 1; i <= 4; i++) {
		let h = new NN.Neuron('I' + i, 0);
		h2s.push(h);
		nodes.push(h);
		outs.forEach((o) => {
			h.link(o, 0.5);
		})
	}

	// let h1s = []

	// for (let i = 1; i <= 4; i++) {
	// 	let h = new Neuron('I' + i, 0);
	// 	h1s.push(h);
	// 	nodes.push(h);
	// 	h2s.forEach((o) => {
	// 		h.link(o, 0.5);
	// 	})
	// }

	let [ns, maxsize] = NN.get_NN(nodes);
	let gd = new NN.Momentum(0.0001, 0);
	gd.init(ns);

	console.log(ns)

	gameconsole.init = (sc) => {
	}

	gameconsole.action = (sc, delta) => {
		if (sc.Keyboard.keymap[' '] && sc.Keyboard.keymap[' '].once) {
			train = !train
		}
	}

	let train = false
	let lossarr1 = [];
	gameconsole.render = (sc, delta) => {
		// test.draw(sc.Renderer, 5, 10, WHITE, 1)
		let loss1
		if (train) {
			for (let i = 0; i < 500; i++) {
				let a = (Math.random() > 0.5) ? 1 : 0
				let b = (Math.random() > 0.5) ? 1 : 0
				let c = (Math.random() > 0.5) ? 1 : 0
				let d = (Math.random() > 0.5) ? 1 : 0
				let out = a * 1 + b * 2 + c * 4 + d * 8
				let [ans, l] = NN.backpropagation(ns, { I1: a, I2: b, I3: c, I4: d }, { Out1: out }, gd)
				loss1 = l
			}
			// console.log(loss)
			lossarr1.push(SUN.Fn.clamp(loss1 * 500, 0, 50))
		}
		NN.draw_NN(40, 20, 100, 100, 13, sc.Renderer, ns, maxsize)
		let len = lossarr1.length
		let w = sc.Renderer.size.x
		for (let i = 1; i < len; i++) {
			sc.Renderer.draw_Line_DDA((i - 1) * w / len, 480 - lossarr1[i - 1], (i) * w / len, 480 - lossarr1[i], SUN.Color.PICO(8))
		}
		if (lossarr1.length > 300) {
			lossarr1.shift();
		}
	}

	gameconsole.run()
</script>

</html>