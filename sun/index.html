<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>GB sun JS</title>
</head>

<body>
	<div id="container">
	</div>
</body>

<style>
	body {
		margin: 0px;
		height: 100%;
		width: 100%;
	}

	#container {
		width: 100%;
		height: 100%;
		/* padding: auto; */
		background-color: rgb(255, 255, 255);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
	}

	#container>canvas {
		/* width: 500px; */
		height: 100%;
		/* width: 100%; */
		/* height: 500px; */
	}
</style>

<script type="module">
	import * as SUN from './GBsun.js'

	let gameconsole = new SUN.sunConsole(256, 256)

	document.getElementById('container').appendChild(gameconsole.get_ConsoleDOM())

	let font = SUN.Font.DEFAULT()

	gameconsole.init = (sc) => {

		// for (let i = 0; i < 4; i++) {
		// 	for (let j = 0; j < 4; j++) {
		// 		let id = i * 4 + j
		// 		const SIZE = sc.Renderer.size.x / 4
		// 		sc.Renderer.draw_Rect(SUN.Rect.XYWH(j * SIZE, i * SIZE, SIZE, SIZE), SUN.Color.PICO(id))
		// 	}
		// }
		// sc.Renderer.draw_Char(50, 50, SUN.Char.DEFAULT('B'), SUN.Color.PICO(0))


	}

	class PixelIndicate {
		constructor() {
			this.position = new SUN.Vector2(0, 0)

		}
	}

	class SpriteEditor {
		constructor() {
			this.topbar_color = SUN.Color.PICO(8)
			this.background_color = SUN.Color.PICO(1)
			this.font = SUN.Font.DEFAULT()
		}

		init(sc) {
			let topbar_height = 12
			this.topbar_rect = SUN.Rect.XYWH(0, 0, sc.Renderer.size.x, topbar_height)
			this.background_rect = SUN.Rect.XYWH(0, topbar_height, sc.Renderer.size.x, sc.Renderer.size.y - topbar_height)
		}

		update(sc, delta) {

		}

		render(sc, delta) {
			// sc.Renderer.clear()
			sc.Renderer.draw_Rect(this.topbar_rect, this.topbar_color)
			sc.Renderer.draw_String(2, 2, 'Sprite Editor', this.font)
			sc.Renderer.draw_Rect(this.background_rect, this.background_color)
		}
	}

	class Console {
		constructor() {
			this.str = ''
			this.list = [['◻◻ '], [], ['◻◻ GAMEBOY SUN JS'], ['   0.0.1', { color: SUN.Color.RGB8(255, 255, 255, 50) }], [],
			['◻◻ by studio UNNAMED', { color: SUN.Color.RGB8(255, 255, 255, 50) }], [], ['◻◻ '], []]
			const font = SUN.Font.DEFAULT()
			this.time = 0
			this.ins = []
			this.idx = 0
			this.backgroundcolor = SUN.Color.RGB8(20, 20, 20)
			this.monkey = SUN.Mesh.LOAD_OBJ('untitled.obj')
			this.camera = new SUN.Camera(new SUN.Vector3(0, 0, -2))
		}

		init() {

		}

		exec_Instruction(instruction, sc, delta) {
			if (instruction === '') {
				this.list.push(['>> ', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
				this.list.push([])
				this.str = ''
				return
			}
			this.list.push(['>> ', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
			this.list.push([instruction, { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
			this.list.push([])
			let array = instruction.split(' ')
			let ins = array[0]
			ins = ins.toUpperCase()
			let arg = array.splice(1, array.length - 1)
			this.ins.push(ins)
			if (ins === 'PALETTE') {
				this.list.push(['◻◻ ', { font: font }])
				this.list.push([SUN.Sprite.COLOR_PALETTE_PICO(), { scale: 8 }])
				this.list.push([])
			}
			else if (ins === 'COLOR') {
				if (arg.length === 1) {
					let color = parseInt(arg[0])
					if (color >= 0 && color <= 15) {
						this.list.push(['◻◻ ', { font: font }])
						this.list.push([new SUN.Sprite([[SUN.Color.PICO(color)]]), { scale: 7 }])
						this.list.push([[['◻PICO: ' + color]]])
						this.list.push([])
						console.log(this.list)
					}
					else {
						this.list.push(['◻◻ Argument(s) error', { color: SUN.Color.RGB8(220, 20, 30) }])
						this.list.push([])
						this.list.push(['◻◻ Instruction ', {}])
						this.list.push(['Color int(0-15)', { color: SUN.Color.PICO(12) }])
						this.list.push([])
					}
				}
				else if (arg.length === 3) {
					let r = parseInt(arg[0])
					let g = parseInt(arg[1])
					let b = parseInt(arg[2])
					this.list.push(['◻◻ ', { font: font }])
					let color = SUN.Color.RGB8(r, g, b)
					this.list.push([new SUN.Sprite([[color]]), { scale: 7 }])
					this.list.push([[['◻R: ' + color.r, { color: SUN.Color.RGB8(255, 0, 0) }], ['◻G: ' + color.g, { color: SUN.Color.RGB8(0, 255, 0) }], ['◻B: ' + color.b, { color: SUN.Color.RGB8(0, 0, 255) }]]])
					this.list.push([])
				}
				else {
					this.list.push(['◻◻ Argument(s) error', { color: SUN.Color.RGB8(220, 20, 30) }])
					this.list.push([])
					this.list.push(['◻◻ Instruction ', {}])
					this.list.push(['Color int, int int int', { color: SUN.Color.PICO(12) }])
					this.list.push([])
				}
			}

			else if (ins === 'CHAR') {
				if (arg.length === 0) {
					this.list.push(['◻◻ ABCDEFGHIJKLMNOPQRSTUVWXYZ', { font: font }])
					this.list.push([])
					this.list.push(['◻◻ ', { font: font }])
					this.list.push(['abcdefghijklmnopqrstuvwxyz', { font: font }])
					this.list.push([])
					this.list.push(['◻◻ ', { font: font }])
					this.list.push(['0123456789', { font: font }])
					this.list.push([])
					this.list.push(['◻◻ ', { font: font }])
					this.list.push(['+-*/<=>.,()[]{}~\'\"?:;_!@#$%^&', { font: font }])
					this.list.push([])
				}
				else if (arg.length === 1) {
					this.list.push([arg[0], { font: font }])
					this.list.push([])
				}
			}
			else if (ins === 'HELP') {
				this.list.push(['◻◻ Instruction\t', { font: font, color: SUN.Color.PICO(12) }])
				// this.list.push(['', { font: font, color: SUN.Color.PICO(12) }])
				this.list.push([])
				this.list.push(['◻◻ HELP\t\t\t\t', { font: font }])
				this.list.push(['show this info', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
				this.list.push([])
				this.list.push(['◻◻ REBOOT\t\t\t', { font: font }])
				this.list.push(['reboot the console', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
				this.list.push([])
				this.list.push(['◻◻ CLS\t\t\t\t\t', { font: font }])
				this.list.push(['clear screen', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
				this.list.push([])
				this.list.push(['◻◻ CHAR\t\t\t\t', { font: font }])
				this.list.push(['log all useable chars', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
				this.list.push([])
				this.list.push(['◻◻ PALETTE\t\t', { font: font }])
				this.list.push(['log pico color palette', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
				this.list.push([])
				this.list.push(['◻◻ COLOR\t\t\t', { font: font }])
				this.list.push(['log a specific color', { font: font, color: SUN.Color.RGB8(255, 255, 255, 50) }])
				this.list.push([])
			}
			else if (ins === 'SUN') {
				let array = '◻◻ Hello Sun! --- from studio UNNAMED'.split('').map((char, index) => {
					return [char, { font: font, color: SUN.Color.PICO((index % 15) + 1) }, (time) => {
						return {
							lineheight: Math.round(Math.cos(time * 0.005 + index * 0.1) * 10 + 10)
						}
					}, null, 28]
				})
				this.list.push([array])
				this.list.push([])
				let array2 = '◻◻ Hello Sun! --- from studio UNNAMED'.split('').map((char, index) => {
					return [char, { font: font, color: SUN.Color.PICO((index % 15) + 1) }, (time) => {
						return {
							color: SUN.Color.RGB(1, 1, 1, Math.sin(-time * 0.005 + index * 0.1) + 1)
							// offest: new SUN.Vector2(Math.round(Math.cos(time * 0.005 + index * 0.1) * 10 + 10), Math.round(Math.cos(time * 0.005 + index * 0.1) * 10 + 10))
							// lineheight: Math.round(Math.cos(time * 0.005 + index * 0.1) * 10 + 10)
						}
					}]
				})
				this.list.push([array2])
				this.list.push([])
			}
			else if (ins === 'LINE') {
				let x0 = arg[0]
				let y0 = arg[1]
				let x1 = arg[2]
				let y1 = arg[3]

			}
			else if (ins === 'BUFFER') {
				console.log(sc.Renderer.buffer)
			}
			else if (ins === 'REBOOT') {
				this.list = [['◻◻ '], [], ['◻◻ GAMEBOY SUN JS'], ['   0.0.1', { color: SUN.Color.RGB8(255, 255, 255, 50) }], [],
				['◻◻ by studio UNNAMED', { color: SUN.Color.RGB8(255, 255, 255, 50) }], [], ['◻◻ '], []]
			}
			else if (ins === 'CLS') {
				this.list = []
			}
			else if (ins === 'FPS') {
				this.list.push(['◻◻ ' + String(Math.round(1000 / delta))])
				this.list.push([])
			}
			else {
				this.list.push(['◻◻ Unknown Command', { color: SUN.Color.RGB8(220, 20, 30) }])
				this.list.push([])
			}
			this.str = ''
			this.idx = 0
		}

		update(sc, delta) {
			for (let key in sc.Keyboard.keymap) {
				if (SUN.Fn.is_ASCII(key)) {
					if (sc.Keyboard.on_Continue(key)) {
						// console.log(SUN.Fn.get_Char(key))
						if (key === 'Enter') {
							// console.log("Instruction", this.str)
							this.exec_Instruction(this.str, sc, delta)
						}
						else if (key === 'Tab') {
							let str = this.str.split('')
							str.splice(this.idx, 0, '\t')
							this.str = str.join('')
							this.idx = SUN.Fn.clamp(this.idx + 1, 0, this.str.length)
						}
						else {
							let str = this.str.split('')
							str.splice(this.idx, 0, key)
							this.str = str.join('')
							this.idx = SUN.Fn.clamp(this.idx + 1, 0, this.str.length)
						}
					}
				}
				else if (key === 'Backspace' || key === 'Delete') {
					if (sc.Keyboard.on_Continue(key)) {
						// console.log(SUN.Fn.get_Char(key))
						let str = this.str.split('')
						str.splice(this.idx - 1, 1)
						this.str = str.join('')
						this.idx = SUN.Fn.clamp(this.idx - 1, 0, this.str.length)
						this.time = 0
					}
				}
				else if (key === 'ArrowLeft') {
					if (sc.Keyboard.on_Continue(key)) {
						this.idx = SUN.Fn.clamp(this.idx - 1, 0, this.str.length)
						this.time = 0
					}
				}
				else if (key === 'ArrowRight') {
					if (sc.Keyboard.on_Continue(key)) {
						this.idx = SUN.Fn.clamp(this.idx + 1, 0, this.str.length)
						this.time = 0
					}
				}
			}
		}

		render(sc, delta) {
			sc.Renderer.clear(this.backgroundcolor)
			sc.Renderer.draw_Mesh(this.monkey, this.camera)

			let cursor
			if (this.time >= 0) {
				cursor = '◼'
			}
			if (this.time >= 500) {
				cursor = '◻'
			}
			if (this.time >= 1000) {
				cursor = '◼'
				this.time = 0
			}
			// let size = font.get_MultiStringRect('>> ' + this.str + cursor, 1, 0, 2).size
			// sc.Renderer.draw_Rect(size, SUN.Color.PICO(10))
			// sc.Renderer.draw_MultiString(4, sc.Renderer.size.y - 4 - size.y - 2, '>> ' + this.str + cursor, font, SUN.Color.COLOR('WHITE'), 1, 0, 2, 1, null, SUN.Color.PICO(5))
			let array = this.list.filter(() => { return true })
			array.push(['>> ', { font: font }])
			let input = []
			let clist = this.str.split('')
			clist.push('◻')
			// console.log(clist) 
			clist.forEach((c, idx) => {
				input.push([c, idx !== this.idx ? { font: font, border: 1, offest: new SUN.Vector2(-1, -1) } : cursor === '◼' ? { font: font, backgroundcolor: SUN.Color.PICO(8), color: SUN.Color.RGB8(23, 33, 67), border: 1, offest: new SUN.Vector2(-1, -1) } : { font: font, border: 1, offest: new SUN.Vector2(-1, -1) }])
			})
			// array.push(['>> ', { font: font }])
			// array.push([this.str, { font: font }])
			array.push([input, { split: -1 }])

			let rect = SUN.get_RichTextRect(array, 1, 0, 4)
			rect.position.x = 5
			rect.position.y = 6
			// sc.Renderer.draw_Rect(rect, SUN.Color.PICO(15))
			if (rect.size.y < sc.Renderer.size.y - 8) {
				sc.Renderer.draw_Richtext(5, 6, array, 1, 0, 4)
			}
			else {
				sc.Renderer.draw_Richtext(5, sc.Renderer.size.y - 4 - rect.size.y, array, 1, 0, 4)
			}
			this.time += delta
		}
	}

	class CodeEditor {
		constructor() {
			this.str = ''
			this.list = []
			const font = SUN.Font.DEFAULT()
			this.time = 0
		}

		get_RichText() {
			let ans = []
			let array = this.str.split(" ")
			array.forEach((item) => {
				let word
				switch (item) {
					case 'func':
						ans.push([item, { color: SUN.Color.PICO(12) }])
						break
					case '(': case ')':
						ans.push([item, { color: SUN.Color.PICO(11) }])
						break
					case '->':
						ans.push(['→', { color: SUN.Color.PICO(11) }])
						break
					case '\n':
						ans.push([])
						break
					default:
						word = item.split('')
						word.forEach((w) => {
							switch (w) {
								case '(': case ')':
									ans.push([w, { color: SUN.Color.PICO(11) }])
									break
								case '\n':
									ans.push([])
									break
								default:
									ans.push([w])
									break
							}
						})
						break
				}
				ans.push([' '])
			})
			return ans
		}

		update(sc, delta) {
			for (let key in sc.Keyboard.keymap) {
				if (SUN.Fn.is_ASCII(key)) {
					if (sc.Keyboard.on_Continue(key)) {
						// console.log(SUN.Fn.get_Char(key))
						if (key === 'Enter') {
							// console.log("Instruction", this.str)
							this.str += '\n'
						}
						else
							this.str += SUN.Fn.get_Char(key)
					}
				}
				else if (key === 'Backspace') {
					if (sc.Keyboard.on_Continue(key)) {
						// console.log(SUN.Fn.get_Char(key))
						this.str = this.str.substr(0, this.str.length - 1)
					}
				}
			}
		}

		render(sc, delta) {
			// console.log(this.get_RichText())
			sc.Renderer.clear()
			sc.Renderer.draw_Richtext(6, 6, this.get_RichText(), 1, 0, 4)
		}
	}


	// let spriteeditor = new SpriteEditor()
	let sunconsole = new Console()

	gameconsole.init = (sc) => {
		sunconsole.init(sc)
	}

	gameconsole.action = (sc, delta) => {
		sunconsole.update(sc, delta)
	}

	gameconsole.render = (sc, delta) => {
		sunconsole.render(sc, delta)
	}

	gameconsole.run()
</script>

</html>